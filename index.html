<!DOCTYPE html>
<html>
<head>
    <title>Mini Militia Clone - With Guns</title>
    <style>
        body { margin: 0; overflow: hidden; background: #5c8a8a; touch-action: none; }
        canvas { display: block; }
        
        /* UI Layer */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }
        .joystick-zone {
            position: absolute; bottom: 50px; width: 150px; height: 150px;
            pointer-events: auto;
        }
        #stick-left { left: 50px; }
        #stick-right { right: 50px; }
    </style>
    
    <script src="https://pixijs.download/v7.x/pixi.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
</head>
<body>

    <div id="ui-layer">
        <div id="stick-left" class="joystick-zone"></div>
        <div id="stick-right" class="joystick-zone"></div>
    </div>

    <script>
        const app = new PIXI.Application({ width: window.innerWidth, height: window.innerHeight, backgroundColor: 0x5c8a8a });
        document.body.appendChild(app.view);

        const player = new PIXI.Container();
        let frontArmContainer, backArmContainer; 
        let body, head, legLeft, legRight;
        
        let moveData = { x: 0, y: 0, active: false };
        let aimData = { angle: 0, active: false };

        // ADDED 'uzi.png' to the list
        const assets = ['arm.png', 'body.png', 'head.png', 'leg.png', 'uzi.png'];

        PIXI.Assets.load(assets).then(setupGame);

        function setupGame() {
            player.x = app.screen.width / 2;
            player.y = app.screen.height / 2;

            // --- LAYER 1: BACK ARM ---
            backArmContainer = createArm();
            backArmContainer.position.set(40, -25); 
            backArmContainer.tint = 0xCCCCCC; 
            player.addChild(backArmContainer);

            // --- LAYER 2: LEGS ---
            legLeft = PIXI.Sprite.from('leg.png');
            legLeft.anchor.set(0.5, 0); 
            legLeft.position.set(-15, 25); 
            player.addChild(legLeft);

            legRight = PIXI.Sprite.from('leg.png');
            legRight.anchor.set(0.5, 0); 
            legRight.position.set(50, 25); 
            player.addChild(legRight);

            // --- LAYER 3: BODY ---
            body = PIXI.Sprite.from('body.png');
            body.anchor.set(0.5);
            player.addChild(body);

            // --- LAYER 4: HEAD ---
            head = PIXI.Sprite.from('head.png');
            head.anchor.set(0.5, 0.9); 
            head.position.set(0, -70);
            player.addChild(head);

            // --- LAYER 5: FRONT ARM (The One with the Gun) ---
            frontArmContainer = createArm();
            frontArmContainer.position.set(-40, -25); 
            player.addChild(frontArmContainer);

            // --- EQUIP WEAPON ---
            // format: equipGun(armContainer, gunImageName, offsetX, offsetY)
            // You can tweak the numbers (55, 15) to fit the gun perfectly in the hand
            equipGun(frontArmContainer, 'uzi.png', 55, 15);

            app.stage.addChild(player);
            app.ticker.add(gameLoop);
            setupControls();
        }

        // --- NEW FLEXIBLE GUN FUNCTION ---
        function equipGun(armContainer, gunTextureName, offsetX, offsetY) {
            // 1. Create Gun Sprite
            const gun = PIXI.Sprite.from(gunTextureName);
            
            // 2. Set Anchor to the Trigger/Handle
            // (0.5, 0.5 means center of gun. Adjust this if the handle is lower)
            gun.anchor.set(0.4, 0.4); 
            
            // 3. Position it relative to the shoulder
            gun.position.set(offsetX, offsetY);
            
            // 4. Add BEHIND the arm sprite?
            // "addChildAt(gun, 0)" puts it behind the arm (so fingers cover the handle)
            // "addChild(gun)" puts it in front of the arm
            armContainer.addChildAt(gun, 0); 
        }

        function createArm() {
            const container = new PIXI.Container();
            const sprite = PIXI.Sprite.from('arm.png');
            sprite.anchor.set(0, 0.5); // Shoulder Pivot
            container.addChild(sprite);
            return container;
        }

        function gameLoop(delta) {
            // MOVEMENT
            if (moveData.active) {
                player.x += moveData.x * 5 * delta;
                player.y += moveData.y * 5 * delta;
                
                legLeft.rotation = Math.sin(Date.now() / 100) * 0.4;
                legRight.rotation = Math.cos(Date.now() / 100) * 0.4;
            } else {
                legLeft.rotation = 0;
                legRight.rotation = 0;
            }

            // AIMING (360 Degree Fix)
            if (aimData.active) {
                let angle = aimData.angle;
                const isLookingLeft = (angle > Math.PI / 2) && (angle < 3 * Math.PI / 2);

                if (isLookingLeft) {
                    player.scale.x = -1; 
                    let correctRot = angle - Math.PI;
                    frontArmContainer.rotation = correctRot;
                    backArmContainer.rotation = correctRot;
                    head.rotation = Math.max(-0.5, Math.min(0.5, correctRot * 0.5));
                } else {
                    player.scale.x = 1;
                    let correctRot = angle;
                    if (angle > Math.PI) correctRot = angle - (Math.PI * 2);
                    
                    frontArmContainer.rotation = -correctRot;
                    backArmContainer.rotation = -correctRot;
                    head.rotation = Math.max(-0.5, Math.min(0.5, -correctRot * 0.5));
                }
            }
        }

        function setupControls() {
            const joyLeft = nipplejs.create({ zone: document.getElementById('stick-left'), mode: 'static', position: { left: '50%', top: '50%' }, color: 'white' });
            joyLeft.on('move', (evt, data) => {
                moveData.active = true;
                moveData.x = Math.cos(data.angle.radian);
                moveData.y = -Math.sin(data.angle.radian);
            });
            joyLeft.on('end', () => { moveData.active = false; });

            const joyRight = nipplejs.create({ zone: document.getElementById('stick-right'), mode: 'static', position: { left: '50%', top: '50%' }, color: 'red' });
            joyRight.on('move', (evt, data) => {
                aimData.active = true;
                aimData.angle = data.angle.radian;
            });
        }
    </script>
</body>
</html>
